rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // âœ… PRODUCTION RULES - CollabCanvas v3
    // Last Updated: 2025-10-19 (Feature 9: Collaboration - Fixed for batch writes)
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Feature 9: Check if user is a collaborator (owner or designer)
    function isCollaborator(canvasId) {
      return exists(/databases/$(database)/documents/canvases/$(canvasId)/collaborators/$(request.auth.uid));
    }
    
    // Feature 9: Check if user is owner of canvas
    function isCanvasOwner(canvasId) {
      let collaborator = get(/databases/$(database)/documents/canvases/$(canvasId)/collaborators/$(request.auth.uid));
      return collaborator.data.role == 'owner';
    }
    
    // Canvas metadata - collaborators can read/write, authenticated users can create
    match /canvases/{canvasId} {
      // Allow creation of new canvas (for initial Lookbook creation)
      allow create: if isAuthenticated();
      // Allow read/update/delete only for collaborators
      allow read, update: if isAuthenticated() && isCollaborator(canvasId);
      allow delete: if isAuthenticated() && isCanvasOwner(canvasId);
      
      // Objects subcollection - all collaborators can edit
      match /objects/{objectId} {
        allow read, write: if isAuthenticated() && isCollaborator(canvasId);
      }
      
      // Layers subcollection - all collaborators can edit
      match /layers/{layerId} {
        allow read, write: if isAuthenticated() && isCollaborator(canvasId);
      }
      
      // Collaborators subcollection (Feature 9)
      match /collaborators/{userId} {
        // Allow creating your own collaborator entry (for initial owner)
        allow create: if isAuthenticated() && request.auth.uid == userId;
        
        // FIXED: Allow reading ALL collaborators if you are a collaborator
        // This is needed for useCollaborators subscription and presence badges
        allow read: if isAuthenticated() && isCollaborator(canvasId);
        
        // For update/delete, check if requester has 'owner' role in their own entry
        allow update, delete: if isAuthenticated() && 
          get(/databases/$(database)/documents/canvases/$(canvasId)/collaborators/$(request.auth.uid)).data.role == 'owner';
      }
    }
    
    // User canvas index - users can only access their own
    match /users/{userId}/canvases/{canvasId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
    
    // User profiles (for user search in Feature 9)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(userId);
    }
  }
}
